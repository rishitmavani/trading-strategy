"""\nMain Orchestration Script\nCoordinates all components of the trading strategy\n"""\n\nimport sys\nimport os\nsys.path.append(os.path.join(os.path.dirname(__file__), 'src'))\n\nimport pandas as pd\nimport numpy as np\nfrom datetime import datetime\nimport warnings\nwarnings.filterwarnings('ignore')\n\nfrom data_collection import DataCollector\nfrom regime_detection import RegimeDetector\nfrom signal_generation import SignalGenerator\nfrom backtesting import Backtester\nfrom utils import (\n    setup_logging, load_config, save_results, \n    validate_data, get_timestamp\n)\n\ndef main():\n    \"\"\"Main execution function\"\"\"\n    \n    print(\"\\n\" + \"=\"*70)\n    print(\"        ADAPTIVE TRADING STRATEGY WITH REGIME DETECTION\")\n    print(\"=\"*70 + \"\\n\")\n    \n    # Load configuration\n    print(\"[1/6] Loading configuration...\")\n    config = load_config('config/config.yaml')\n    \n    # Setup logging\n    setup_logging(\n        log_file=config['logging']['log_file'],\n        level=getattr(__import__('logging'), config['logging']['level'])\n    )\n    \n    # Initialize components\n    print(\"[2/6] Initializing components...\")\n    data_collector = DataCollector(\n        symbols=config['data']['symbols'],\n        timeframes=config['data']['timeframes']\n    )\n    \n    regime_detector = RegimeDetector(\n        n_regimes=config['regime']['n_regimes']\n    )\n    \n    signal_generator = SignalGenerator(config=config['signals'])\n    \n    backtester = Backtester(\n        initial_capital=config['risk']['initial_capital'],\n        commission=config['backtest']['commission'],\n        slippage=config['backtest']['slippage']\n    )\n    \n    # Process each symbol\n    all_results = {}\n    \n    for symbol in config['data']['symbols']:\n        print(f\"\\n{'='*70}\")\n        print(f\"Processing: {symbol}\")\n        print(\"=\"*70)\n        \n        try:\n            # Fetch data\n            print(f\"[3/6] Fetching data for {symbol}...\")\n            primary_tf = config['signals']['primary_timeframe']\n            \n            if config['signals']['use_multi_timeframe']:\n                data_dict = data_collector.fetch_multi_timeframe_data(\n                    symbol=symbol,\n                    start_date=config['data']['start_date']\n                )\n                \n                if not data_dict or primary_tf not in data_dict:\n                    print(f\"Failed to fetch data for {symbol}. Skipping...\")\n                    continue\n                \n                df = data_dict[primary_tf]\n            else:\n                df = data_collector.fetch_data(\n                    symbol=symbol,\n                    timeframe=primary_tf,\n                    start_date=config['data']['start_date']\n                )\n                \n                if df.empty:\n                    print(f\"No data available for {symbol}. Skipping...\")\n                    continue\n                \n                df = data_collector.add_technical_indicators(df)\n                data_dict = {primary_tf: df}\n            \n            # Validate data\n            is_valid, errors = validate_data(df)\n            if not is_valid:\n                print(f\"Data validation failed for {symbol}:\")\n                for error in errors:\n                    print(f\"  - {error}\")\n                continue\n            \n            print(f\"  Loaded {len(df)} data points\")\n            print(f\"  Date range: {df.index[0]} to {df.index[-1]}\")\n            \n            # Detect regimes\n            print(f\"[4/6] Detecting market regimes...\")\n            method = config['regime']['method']\n            \n            if method == 'hmm':\n                regimes = regime_detector.detect_regime_hmm(df)\n            elif method == 'volatility':\n                regimes = regime_detector.detect_regime_volatility(df)\n            elif method == 'trend':\n                regimes = regime_detector.detect_regime_trend(df)\n            else:  # combined\n                regimes = regime_detector.detect_regime_combined(df)\n            \n            # Print regime statistics\n            regime_stats = regime_detector.get_regime_stats(df, regimes)\n            print(\"\\n  Regime Distribution:\")\n            for regime_name, stats in regime_stats.items():\n                print(f\"\\n  {regime_name}:\")\n                print(f\"    Occurrence: {stats['percentage']:.1f}% ({stats['count']} periods)\")\n                print(f\"    Avg Return: {stats['avg_return']:.2f}%\")\n                print(f\"    Volatility: {stats['volatility']:.2f}%\")\n                print(f\"    Sharpe: {stats['sharpe']:.2f}\")\n            \n            # Generate signals\n            print(f\"\\n[5/6] Generating trading signals...\")\n            \n            if config['signals']['use_multi_timeframe']:\n                # Detect regimes for all timeframes\n                regimes_dict = {}\n                for tf, tf_data in data_dict.items():\n                    if method == 'combined':\n                        regimes_dict[tf] = regime_detector.detect_regime_combined(tf_data)\n                    else:\n                        regimes_dict[tf] = regime_detector.detect_regime_hmm(tf_data)\n                \n                signals = signal_generator.generate_multi_timeframe_signals(\n                    data_dict, regimes_dict\n                )\n            else:\n                signals = signal_generator.generate_signals(df, regimes)\n            \n            # Apply filters\n            signals = signal_generator.apply_filters(signals, df)\n            \n            # Count signals\n            buy_signals = (signals['signal'] == 1).sum()\n            sell_signals = (signals['signal'] == -1).sum()\n            hold_signals = (signals['signal'] == 0).sum()\n            \n            print(f\"  Generated {len(signals)} signal periods:\")\n            print(f\"    Buy:  {buy_signals}\")\n            print(f\"    Sell: {sell_signals}\")\n            print(f\"    Hold: {hold_signals}\")\n            print(f\"    Average Confidence: {signals['confidence'].mean():.2%}\")\n            \n            # Run backtest\n            print(f\"\\n[6/6] Running backtest...\")\n            backtest_results = backtester.run_backtest(df, signals)\n            \n            # Print metrics\n            print(\"\\n  Performance Metrics:\")\n            metrics = backtest_results['metrics']\n            for key, value in metrics.items():\n                print(f\"    {key}: {value}\")\n            \n            # Store results\n            all_results[symbol] = {\n                'data': df,\n                'regimes': regimes,\n                'signals': signals,\n                'backtest': backtest_results,\n                'regime_stats': regime_stats\n            }\n            \n            # Plot results if enabled\n            if config['backtest']['plot_results']:\n                output_dir = config['backtest']['output_dir']\n                os.makedirs(output_dir, exist_ok=True)\n                \n                plot_path = os.path.join(\n                    output_dir, \n                    f\"{symbol.replace('-', '_')}_{get_timestamp()}.png\"\n                )\n                backtester.plot_results(save_path=plot_path)\n                print(f\"\\n  Plot saved to: {plot_path}\")\n            \n            # Generate report\n            report = backtester.generate_report()\n            print(report)\n            \n        except Exception as e:\n            print(f\"\\nError processing {symbol}: {e}\")\n            import traceback\n            traceback.print_exc()\n            continue\n    \n    # Save all results\n    if config['backtest']['save_results'] and all_results:\n        output_dir = config['backtest']['output_dir']\n        os.makedirs(output_dir, exist_ok=True)\n        \n        results_path = os.path.join(\n            output_dir,\n            f\"results_{get_timestamp()}.json\"\n        )\n        \n        # Prepare summary results\n        summary = {}\n        for symbol, results in all_results.items():\n            summary[symbol] = {\n                'metrics': results['backtest']['metrics'],\n                'regime_stats': results['regime_stats']\n            }\n        \n        save_results(summary, results_path)\n        print(f\"\\nResults saved to: {results_path}\")\n    \n    print(\"\\n\" + \"=\"*70)\n    print(\"                    EXECUTION COMPLETED\")\n    print(\"=\"*70 + \"\\n\")\n\nif __name__ == \"__main__\":\n    main()