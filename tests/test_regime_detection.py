"""\nUnit tests for Regime Detection Module\n"""\n\nimport sys\nimport os\nsys.path.append(os.path.join(os.path.dirname(__file__), '..', 'src'))\n\nimport unittest\nimport pandas as pd\nimport numpy as np\nfrom regime_detection import RegimeDetector\n\nclass TestRegimeDetector(unittest.TestCase):\n    \"\"\"Test cases for RegimeDetector class\"\"\"\n    \n    def setUp(self):\n        \"\"\"Set up test data\"\"\"\n        # Create synthetic OHLCV data\n        dates = pd.date_range(start='2023-01-01', end='2023-12-31', freq='1H')\n        n = len(dates)\n        \n        # Generate price data with different regimes\n        np.random.seed(42)\n        \n        # Trending up phase\n        trend_up = np.linspace(100, 150, n//3) + np.random.randn(n//3) * 2\n        \n        # Ranging phase\n        ranging = 150 + np.random.randn(n//3) * 3\n        \n        # Trending down phase\n        trend_down = np.linspace(150, 120, n//3) + np.random.randn(n//3) * 2\n        \n        close = np.concatenate([trend_up, ranging, trend_down])[:n]\n        \n        self.df = pd.DataFrame({\n            'open': close + np.random.randn(n) * 0.5,\n            'high': close + abs(np.random.randn(n)) * 1,\n            'low': close - abs(np.random.randn(n)) * 1,\n            'close': close,\n            'volume': np.random.randint(1000, 10000, n)\n        }, index=dates)\n        \n        self.detector = RegimeDetector(n_regimes=3)\n    \n    def test_initialization(self):\n        \"\"\"Test RegimeDetector initialization\"\"\"\n        self.assertEqual(self.detector.n_regimes, 3)\n        self.assertIsNone(self.detector.hmm_model)\n        self.assertEqual(len(self.detector.regime_names), 3)\n    \n    def test_calculate_features(self):\n        \"\"\"Test feature calculation\"\"\"\n        features = self.detector.calculate_features(self.df)\n        \n        # Check that features are calculated\n        self.assertIsInstance(features, pd.DataFrame)\n        self.assertGreater(len(features), 0)\n        \n        # Check expected columns\n        expected_cols = ['returns', 'volatility', 'trend_strength', 'adx', 'volume_ratio']\n        for col in expected_cols:\n            self.assertIn(col, features.columns)\n        \n        # Check no NaN values in key features\n        self.assertFalse(features[expected_cols].isnull().all().any())\n    \n    def test_detect_regime_hmm(self):\n        \"\"\"Test HMM-based regime detection\"\"\"\n        regimes = self.detector.detect_regime_hmm(self.df)\n        \n        # Check output\n        self.assertIsInstance(regimes, pd.Series)\n        self.assertGreater(len(regimes), 0)\n        \n        # Check regime values are valid\n        unique_regimes = regimes.unique()\n        self.assertTrue(all(r in [0, 1, 2] for r in unique_regimes))\n        \n        # Check that model was fitted\n        self.assertIsNotNone(self.detector.hmm_model)\n    \n    def test_detect_regime_volatility(self):\n        \"\"\"Test volatility-based regime detection\"\"\"\n        regimes = self.detector.detect_regime_volatility(self.df)\n        \n        # Check output\n        self.assertIsInstance(regimes, pd.Series)\n        self.assertEqual(len(regimes), len(self.df))\n        \n        # Check regime values\n        unique_regimes = regimes.unique()\n        self.assertTrue(all(r in [0, 1, 2] for r in unique_regimes))\n    \n    def test_detect_regime_trend(self):\n        \"\"\"Test trend-based regime detection\"\"\"\n        regimes = self.detector.detect_regime_trend(self.df)\n        \n        # Check output\n        self.assertIsInstance(regimes, pd.Series)\n        self.assertEqual(len(regimes), len(self.df))\n        \n        # Check regime values\n        unique_regimes = regimes.unique()\n        self.assertTrue(all(r in [0, 1, 2] for r in unique_regimes))\n    \n    def test_detect_regime_combined(self):\n        \"\"\"Test combined regime detection\"\"\"\n        regimes = self.detector.detect_regime_combined(self.df)\n        \n        # Check output\n        self.assertIsInstance(regimes, pd.Series)\n        self.assertGreater(len(regimes), 0)\n        \n        # Check regime values\n        unique_regimes = regimes.unique()\n        self.assertTrue(all(r in [0, 1, 2] for r in unique_regimes))\n    \n    def test_get_regime_stats(self):\n        \"\"\"Test regime statistics calculation\"\"\"\n        regimes = self.detector.detect_regime_hmm(self.df)\n        stats = self.detector.get_regime_stats(self.df, regimes)\n        \n        # Check output structure\n        self.assertIsInstance(stats, dict)\n        self.assertGreater(len(stats), 0)\n        \n        # Check each regime has stats\n        for regime_name, regime_stats in stats.items():\n            self.assertIn('count', regime_stats)\n            self.assertIn('percentage', regime_stats)\n            self.assertIn('avg_return', regime_stats)\n            self.assertIn('volatility', regime_stats)\n            self.assertIn('sharpe', regime_stats)\n            \n            # Check values are reasonable\n            self.assertGreaterEqual(regime_stats['count'], 0)\n            self.assertGreaterEqual(regime_stats['percentage'], 0)\n            self.assertLessEqual(regime_stats['percentage'], 100)\n    \n    def test_regime_consistency(self):\n        \"\"\"Test that regimes are reasonably stable\"\"\"\n        regimes = self.detector.detect_regime_hmm(self.df)\n        \n        # Calculate regime changes\n        regime_changes = (regimes != regimes.shift(1)).sum()\n        \n        # Regime shouldn't change every period\n        # Allow max 20% regime changes\n        max_changes = len(regimes) * 0.2\n        self.assertLess(regime_changes, max_changes)\n\nif __name__ == '__main__':\n    unittest.main()